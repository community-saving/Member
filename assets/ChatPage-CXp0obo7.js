import{S as e,T as t,_ as n,a as r,c as i,f as a,g as o,h as s,i as c,l,m as u,o as d,p as f,s as p,u as m}from"./index-ablB7EkJ.js";var h=t(e()),g=t(r());function _(){let{currentUser:e}=c(),[t,r]=(0,h.useState)([]),[_,v]=(0,h.useState)(``),[y,b]=(0,h.useState)(!0),[x,S]=(0,h.useState)({}),[C,w]=(0,h.useState)(null),[T,E]=(0,h.useState)(null),[D,O]=(0,h.useState)(!1),k=(0,h.useRef)(),A=(0,h.useRef)(null),j=(0,h.useRef)(null),M=e=>{if(!e)return!1;let t=e.toDate?e.toDate():new Date(e);return new Date-t<6e4};(0,h.useEffect)(()=>{if(!e)return;(async()=>{try{let t=l(d,`users`,e.uid);(await m(t)).exists()?await n(t,{isOnline:!0,lastActive:s()}):await o(t,{isOnline:!0,lastActive:s(),email:e.email,displayName:e.email.split(`@`)[0]})}catch(e){console.error(`Error setting user online:`,e)}})(),A.current=setInterval(async()=>{try{let t=l(d,`users`,e.uid);await n(t,{isOnline:!0,lastActive:s()})}catch(e){console.error(`Error updating presence:`,e)}},3e4);let t=async()=>{try{let t=l(d,`users`,e.uid);await n(t,{isOnline:!1,lastActive:s()})}catch(e){console.error(`Error setting user offline:`,e)}};return window.addEventListener(`beforeunload`,t),()=>{A.current&&clearInterval(A.current),window.removeEventListener(`beforeunload`,t),t()}},[e]),(0,h.useEffect)(()=>{if(!e)return;let t=u(i(d,`messages`),f(`timestamp`,`asc`)),n=a(t,e=>{r(e.docs.map(e=>({id:e.id,...e.data()}))),b(!1)}),o=i(d,`users`),s=a(o,e=>{let t={};e.forEach(e=>{let n=e.data();t[e.id]={isOnline:n.isOnline||!1,lastActive:n.lastActive,displayName:n.displayName||n.email?.split(`@`)[0]||`Unknown`}}),S(t)});return()=>{n(),s()}},[e]);let N=async e=>{let t=new FormData;t.append(`file`,e),t.append(`upload_preset`,`money-saving`);try{return(await(await fetch(`https://api.cloudinary.com/v1_1/dyprdh3rs/image/upload`,{method:`POST`,body:t})).json()).secure_url}catch(e){throw console.error(`Error uploading image:`,e),e}},P=e=>{let t=e.target.files[0];if(!t)return;if(!t.type.match(`image.*`)){alert(`Please select an image file`);return}w(t);let n=URL.createObjectURL(t);E(n)},F=()=>{w(null),E(null),j.current&&(j.current.value=``)},I=async t=>{if(t.preventDefault(),!(!_.trim()&&!C)){O(!0);try{let t=null;C&&(t=await N(C)),await p(i(d,`messages`),{text:_,imageUrl:t,userId:e.uid,userName:e.email.split(`@`)[0],timestamp:s()}),v(``),w(null),E(null),j.current&&(j.current.value=``)}catch(e){console.error(`Error sending message:`,e),alert(`Failed to send message. Please try again.`)}finally{O(!1)}}};(0,h.useEffect)(()=>{k.current?.scrollIntoView({behavior:`smooth`})},[t]);let L=e=>e?e.toDate().toLocaleTimeString([],{hour:`2-digit`,minute:`2-digit`}):``;return(0,g.jsxs)(`div`,{className:`chat-container`,children:[(0,g.jsxs)(`div`,{className:`chat-header`,children:[(0,g.jsxs)(`div`,{className:`chat-header-avatar`,children:[e?.email?.charAt(0).toUpperCase()||`U`,(0,g.jsx)(`div`,{className:`online-status-indicator ${M(x[e?.uid]?.lastActive)?`online`:`offline`}`,title:M(x[e?.uid]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`chat-header-info`,children:[(0,g.jsx)(`h1`,{children:`Chat Room`}),(0,g.jsxs)(`p`,{children:[t.length,` Messages`]}),(0,g.jsxs)(`p`,{children:[`Online Users: `,(()=>Object.entries(x).filter(([e,t])=>M(t.lastActive)).sort(([e,t],[n,r])=>t.displayName.localeCompare(r.displayName)))().length]})]})]}),(0,g.jsxs)(`div`,{className:`messages-container`,children:[y?(0,g.jsx)(`div`,{className:`loading-indicator`,children:(0,g.jsxs)(`div`,{className:`loading-dots`,children:[(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`})]})}):t.length===0?(0,g.jsxs)(`div`,{className:`empty-state`,children:[(0,g.jsx)(`div`,{className:`empty-state-icon`,children:`ðŸ’¬`}),(0,g.jsx)(`div`,{className:`empty-state-text`,children:`No messages yet. Start a conversation!`})]}):t.map(t=>(0,g.jsxs)(`div`,{className:`message ${t.userId===e.uid?`message-sent`:`message-received`}`,children:[t.userId!==e.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-received`,children:[t.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${M(x[t.userId]?.lastActive)?`online`:`offline`}`,title:M(x[t.userId]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`message-bubble ${t.userId===e.uid?`message-bubble-sent`:`message-bubble-received`}`,children:[t.imageUrl?(0,g.jsx)(`div`,{className:`message-image`,children:(0,g.jsx)(`img`,{src:t.imageUrl,alt:`Uploaded content`})}):null,t.text&&(0,g.jsx)(`div`,{className:`message-text`,children:t.text}),(0,g.jsx)(`div`,{className:`message-timestamp`,children:L(t.timestamp)})]}),t.userId===e.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-sent`,children:[t.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${M(x[t.userId]?.lastActive)?`online`:`offline`}`,title:M(x[t.userId]?.lastActive)?`Online`:`Offline`})]})]},t.id)),(0,g.jsx)(`div`,{ref:k}),D&&(0,g.jsxs)(`div`,{className:`sending-indicator`,children:[(0,g.jsxs)(`div`,{className:`sending-dots`,children:[(0,g.jsx)(`div`,{className:`sending-dot`}),(0,g.jsx)(`div`,{className:`sending-dot`}),(0,g.jsx)(`div`,{className:`sending-dot`})]}),(0,g.jsx)(`span`,{children:`Sending...`})]})]}),(0,g.jsxs)(`form`,{onSubmit:I,className:`input-container`,children:[T&&(0,g.jsxs)(`div`,{className:`image-preview-container`,children:[(0,g.jsx)(`img`,{src:T,alt:`Preview`}),(0,g.jsx)(`div`,{style:{marginLeft:`12px`,flex:1,minWidth:0},children:(0,g.jsx)(`p`,{style:{margin:0,fontSize:`0.85rem`,color:`#4b5563`,whiteSpace:`nowrap`,overflow:`hidden`,textOverflow:`ellipsis`},children:C?.name})}),(0,g.jsx)(`button`,{type:`button`,onClick:F,className:`remove-image-button`,children:`Ã—`})]}),(0,g.jsxs)(`div`,{className:`input-wrapper`,children:[(0,g.jsx)(`input`,{type:`text`,className:`message-input`,placeholder:`Type a message...`,value:_,onChange:e=>v(e.target.value),disabled:D}),(0,g.jsxs)(`div`,{className:`button-group`,children:[(0,g.jsx)(`input`,{type:`file`,ref:j,onChange:P,accept:`image/*`,style:{display:`none`},disabled:D}),(0,g.jsx)(`button`,{type:`button`,className:`send-button`,onClick:()=>j.current.click(),disabled:D,children:(0,g.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 24 24`,fill:`currentColor`,className:`send-icon`,children:(0,g.jsx)(`path`,{fillRule:`evenodd`,d:`M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z`,clipRule:`evenodd`})})}),(0,g.jsx)(`button`,{type:`submit`,className:`send-button`,disabled:!_.trim()&&!C||D,children:D?(0,g.jsx)(`div`,{className:`loading-spinner`,style:{width:`18px`,height:`18px`}}):(0,g.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 24 24`,fill:`currentColor`,className:`send-icon`,children:(0,g.jsx)(`path`,{d:`M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z`})})})]})]})]})]})}var v=()=>(0,g.jsx)(`div`,{style:{marginTop:`65px`},children:(0,g.jsx)(_,{})});export{v as default};