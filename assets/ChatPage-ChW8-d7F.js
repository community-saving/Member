import{C as e,a as t,b as n,c as r,d as i,f as a,h as o,i as s,m as c,n as l,o as u,p as d,r as f,s as p,u as m}from"./index-Cf7ModCx.js";var h=e(n()),g=e(f());function _(){let{currentUser:e}=l(),[n,f]=(0,h.useState)([]),[_,v]=(0,h.useState)(``),[y,b]=(0,h.useState)(!0),[x,S]=(0,h.useState)({}),C=(0,h.useRef)(),w=(0,h.useRef)(null),T=e=>{if(!e)return!1;let t=e.toDate?e.toDate():new Date(e);return new Date-t<6e4};(0,h.useEffect)(()=>{if(!e)return;(async()=>{try{let t=p(s,`users`,e.uid);(await r(t)).exists()?await o(t,{isOnline:!0,lastActive:d()}):await c(t,{isOnline:!0,lastActive:d(),email:e.email,displayName:e.email.split(`@`)[0]})}catch(e){console.error(`Error setting user online:`,e)}})(),w.current=setInterval(async()=>{try{let t=p(s,`users`,e.uid);await o(t,{isOnline:!0,lastActive:d()})}catch(e){console.error(`Error updating presence:`,e)}},3e4);let t=async()=>{try{let t=p(s,`users`,e.uid);await o(t,{isOnline:!1,lastActive:d()})}catch(e){console.error(`Error setting user offline:`,e)}};return window.addEventListener(`beforeunload`,t),()=>{w.current&&clearInterval(w.current),window.removeEventListener(`beforeunload`,t),t()}},[e]),(0,h.useEffect)(()=>{if(!e)return;let t=a(u(s,`messages`),i(`timestamp`,`asc`)),n=m(t,e=>{f(e.docs.map(e=>({id:e.id,...e.data()}))),b(!1)}),r=u(s,`users`),o=m(r,e=>{let t={};e.forEach(e=>{let n=e.data();t[e.id]={isOnline:n.isOnline||!1,lastActive:n.lastActive,displayName:n.displayName||n.email?.split(`@`)[0]||`Unknown`}}),S(t)});return()=>{n(),o()}},[e]);let E=async n=>{if(n.preventDefault(),_.trim())try{await t(u(s,`messages`),{text:_,userId:e.uid,userName:e.email.split(`@`)[0],timestamp:d()}),v(``)}catch(e){console.error(`Error sending message:`,e)}};(0,h.useEffect)(()=>{C.current?.scrollIntoView({behavior:`smooth`})},[n]);let D=e=>e?e.toDate().toLocaleTimeString([],{hour:`2-digit`,minute:`2-digit`}):``;return(0,g.jsxs)(`div`,{className:`chat-container`,children:[(0,g.jsxs)(`div`,{className:`chat-header`,children:[(0,g.jsxs)(`div`,{className:`chat-header-avatar`,children:[e?.email?.charAt(0).toUpperCase()||`U`,(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[e?.uid]?.lastActive)?`online`:`offline`}`,title:T(x[e?.uid]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`chat-header-info`,children:[(0,g.jsx)(`h1`,{children:`Chat Room`}),(0,g.jsxs)(`p`,{children:[n.length,` Messages`]}),(0,g.jsxs)(`p`,{children:[`Online Users: `,(()=>Object.entries(x).filter(([e,t])=>T(t.lastActive)).sort(([e,t],[n,r])=>t.displayName.localeCompare(r.displayName)))().length]})]})]}),(0,g.jsxs)(`div`,{className:`messages-container`,children:[y?(0,g.jsx)(`div`,{className:`loading-indicator`,children:(0,g.jsxs)(`div`,{className:`loading-dots`,children:[(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`}),(0,g.jsx)(`div`,{className:`loading-dot`})]})}):n.length===0?(0,g.jsxs)(`div`,{className:`empty-state`,children:[(0,g.jsx)(`div`,{className:`empty-state-icon`,children:`ðŸ’¬`}),(0,g.jsx)(`div`,{className:`empty-state-text`,children:`No messages yet. Start a conversation!`})]}):n.map(t=>(0,g.jsxs)(`div`,{className:`message ${t.userId===e.uid?`message-sent`:`message-received`}`,children:[t.userId!==e.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-received`,children:[t.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[t.userId]?.lastActive)?`online`:`offline`}`,title:T(x[t.userId]?.lastActive)?`Online`:`Offline`})]}),(0,g.jsxs)(`div`,{className:`message-bubble ${t.userId===e.uid?`message-bubble-sent`:`message-bubble-received`}`,children:[(0,g.jsx)(`div`,{className:`message-text`,children:t.text}),(0,g.jsx)(`div`,{className:`message-timestamp`,children:D(t.timestamp)})]}),t.userId===e.uid&&(0,g.jsxs)(`div`,{className:`message-avatar message-avatar-sent`,children:[t.userName.charAt(0).toUpperCase(),(0,g.jsx)(`div`,{className:`online-status-indicator ${T(x[t.userId]?.lastActive)?`online`:`offline`}`,title:T(x[t.userId]?.lastActive)?`Online`:`Offline`})]})]},t.id)),(0,g.jsx)(`div`,{ref:C})]}),(0,g.jsxs)(`form`,{onSubmit:E,className:`input-container`,children:[(0,g.jsx)(`div`,{className:`input-wrapper`,children:(0,g.jsx)(`input`,{type:`text`,className:`message-input`,placeholder:`Type a message...`,value:_,onChange:e=>v(e.target.value)})}),(0,g.jsx)(`button`,{type:`submit`,className:`send-button`,disabled:!_.trim(),children:(0,g.jsx)(`svg`,{xmlns:`http://www.w3.org/2000/svg`,viewBox:`0 0 24 24`,fill:`currentColor`,className:`send-icon`,children:(0,g.jsx)(`path`,{d:`M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z`})})})]})]})}var v=()=>(0,g.jsx)(`div`,{style:{marginTop:`65px`},children:(0,g.jsx)(_,{})});export{v as default};